---
title: Connecting from External Azure Resources
---


There are three different Azure connectivity solutions you can use to
connect to your cluster from Azure cloud applications. Each solution offers a different level of availability and security. The Azure Private Endpoint is the recommended solution and is applicable in most scenarios, but you can implement other solutions depending on your organization's requirements. 


## Azure Private Endpoint (Recommended)

 Azure Private Endpoint is a network interface that securely connects a private IP 
 address from your VNet to an external service. You only grant access to a single PG service instead of the entire EDB Cloud resource virtual network, thus ensuring maximum network isolation. For more information, see [Azure Private Endpoint](https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview).

**Pros**
 - Service provider's and consumer's locations can be in different virtual networks and different subscriptions. 
 - Single set up can be shared with all consumers. 
 - No IP overlapping risk. 
 - Traffic passes securely through the Microsoft backbone network and not the internet.                                              
 - Most Azure homebrew services (such as CosmosDB) have built-in 
  [private link resources](https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview#private-link-resource) that you can connect to via a private endpoint.

**Cons**
 - EDB Cloud virtual network can not initiate traffic to your application.
 - There is an associated cost. See [Azure Private Link pricing](https://azure.microsoft.com/en-us/pricing/details/private-link/#pricing).

See the [Azure Private Endpoint example](#azure-private-endpoint-example) for the steps for connecting using this solution.

## Virtual Network Peering

Virtual network peering connects two Azure virtual networks. Once
peered, the virtual networks appear as one for connectivity purposes.
Traffic between virtual machines in the peered virtual networks is
routed through the Microsoft backbone infrastructure, through private IP
addresses and not the internet.

**Pros**
- Service provider's and consumer's virtual networks can be in different regions, subscriptions, or tenants. 
- Simple and easy to set up.
- Traffic passes securely through the Microsoft backbone network and not the internet.  
- The IP ranges of two peered virtual networks can not overlap. 

**Cons**
- There is an associated cost. See [pricing for virtual network peering](https://azure.microsoft.com/en-us/pricing/details/virtual-network/#pricing)  for details.                                                      

## Azure VNet-VNet Connection

A VPN gateway is used to send encrypted traffic between Azure virtual networks. You can
connect your EDB Cloud virtual network and your client VM virtual network by using the VNet-to-VNet VPN gateway connection.

**Pros**
 - Traffic passes through an encrypted tunnel.
 - Service provider's and consumer's virtual networks can belong to different regions, subscriptions, or tenants. 
- All traffic is all through Microsoft backbone network, never going through the internet. 
- PG service domain name is accessible directly without a NAT. 
- VNets from different subscriptions do not need to be associated with the same Active Directory tenant.

**Cons**
- Limited bandwidth, see [virtual network gateway planning table](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#planningtable). 
- Set up is complicated. 
- There is an associated cost, see [virtual network gateway planning table](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#planningtable). 



## Walkthroughs

This section contains walkthroughs to guide you through each of the connection solutions. For the examples used in the walkthroughs, assume that your EDB Cloud cluster is on a subscription called `development` and is being accessed from a VM on another subscription `test`.

To walk through an example in your own environment, you need: 
 - Your EDB Cloud cluster URL. You can find the URL in the **Connect** tab of your cluster instance in the EDB Cloud portal.
 -  IP address of your EDB Cloud cluster. For example:
   ```
  $ dig +short p-c4j0jfcmp3af2ieok5eg.brcxzr08qr7rbei1.edbcloud.io 
  10.240.1.218
 ```
 -  A Linux VM called `vm-client` on subscription `test` with the following properties:
    -   Subscription: `test`
    -   resource group: `rg-client`
    -   virtual network: `vnet-client`
    -   virtual network subnet: `snet-client`
 - [psql Postgresql client](https://www.postgresql.org/download/) installed on your VM.
 - Access to the Azure CLI and Azure portal.

### Azure Private Endpoint Example
These are the steps to connect using Azure Private Endpoint. To walk through this example in you own environment, see the prerequisites described in [Walkthroughs](#walkthroughs).

#### Step 1: Create an Azure Private Link Service tied to your EBD Cloud PG service**
 
  In the EDB Cloud cluster's virtual network, 
  create an [Azure Private Link Service](https://docs.microsoft.com/en-us/azure/private-link/private-link-service-overview) in your EDB Cloud cluster resource group. 

  1. Obtain the resource group details with a CLI command or from the Azure portal and note down the resource group name. For example, if the EDB Cloud cluster's virtual network is `vnet-japaneast`, use the following command: 
 
     ```
       $ az network vnet list --query
      "[?name==\'vnet-japaneast\'].resourceGroup" -o json

     ```
  
  1. On the upper-left part of the page in the Azure portal, select **Create a resource**.
  
  1. Search for Private Link in the Search the Marketplace box.

  1. Select **Create**.

  1. Enter `pg-service-private-link` as the name for the Private Link Service and provide additional details as shown in the following screenshot. 
    
    ![](images/image5.png)

  3. In the **Outbound settings** page, select the `kubernetes-inernal` load balancer,
    and select the IP address of your cluster from **Load balancer frontend IP
    address**.

     ![](images/image1.png)

  4. On the **Access security** page, configure the level of access for the private link service. 
    Depending on the visibility level you set on this page, the client application might need to request access
    permission from the EDB Cloud tenant to access this private link
    service. See [control service exposure](https://docs.microsoft.com/en-us/azure/private-link/private-link-service-overview#control-service-exposure)
    for details.

     ![](images/image21.png)

  5. After the Private Link Service is created, note down its `alias`. The `alias`
   is the unique ID for your private service that can be shared offline with any of
   the service consumers. Obtain the 'alias' either from the Azure portal
   or by the using the following CLI command:

     ```
       $ az network private-link-service list --query 
      "[?name=='pg-service-private-link'].alias" -o tsv
      pg-service-private-link.48f26b42-45dc-4e80-8e3d-307d58d7d274.japaneast.azure.privatelinkservice
     
     ```
  6. Select **Review + Create**.

  7. Select **Create**.

#### Step 2: Create an Azure Private Endpoint linking to the Private Link Service**

  To connect to the PG service create an Azure Private Endpoint in your VM's virtual network. After you have created the private endpoint, you can use its private IP address to access the PG service.
  
  1. On the upper-left side of the screen in the portal, select **Create a resource > Networking > Private Link**, or in the search box enter Private Link.

  1. Select **Create**.

  1.In Private Link Center, select Private endpoints in the left-hand menu.

  1. In Private endpoints, select + Add.

  1. Enter pg-service-private-link as the name for the Private Link Service and provide additional details as shown in the following screeshot.

   ![](images/image12.png)

  1. Connect the private endpoint to the EDB Cloud private link service we created by entering its alias.

   ![](images/image17.png)

  1. In the **Configuration** page, enter the VM's Virtual Network `vnet-client`.

  1. Select **Review + Create**.

  7. Select **Create**.

According to the **Visibility** option you set for your private link
resource in the previous step, your private endpoint may need the
EDB Cloud tenant to approve the access to PG private link service. For
the detailed access request and approval workflow see [Access to a
private link resource using approval
workflow](https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview#access-to-a-private-link-resource-using-approval-workflow).

After being created, the private endpoint is in Pending status,
waiting for the approval from the `pg-service-private-link` owner.

IMAGE PLACEHOLDER

Switch to the EDB Cloud subscription and approve the connection request
from the **Pending connections** page in **Private Link Center**.

IMAGE PLACEHOLDER

At this point, you've built a tunnel between your VM virtual network and
EDB Cloud cluster network, you access private PG service with private IP
from your VM now. The private IP is tied to an independent virtual
network NIC, you can get the private IP with following scripts.

```
  $ NICID=$(az network private-endpoint show -n pl-private-pg-service
  -g rg-client --query "networkInterfaces[0].id" -o tsv)
  $ az network nic show -n ${NICID##*/} -g rg-client --query
  "ipConfigurations[0].privateIpAddress" -o tsv
  100.64.111.5
```

Then from VM `vm-client`, you can access PG service with an IP address.

IMAGE PLACEHOLDER

#### Step 3: Create Azure Private DNS Zone for Private Endpoint

Accessing a PG service with an IP address is insecure, as client has no
chance to verify EBD Cloud service certificate to make a trusted
connection. And it is inconvenient for sure, when IP address changes,
you have to update your application too. Practically, you can solve
these problems by creating a [Azure Private DNS Zone](https://docs.microsoft.com/en-us/azure/dns/private-dns-privatednszone) 
for the Private Endpoint. Azure Service Endpoint support associates a private DNS to its [homebrew
private link
resources](https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview#private-link-resource)
in a one-button manner. However, it does not support the Private Link
Service custom type. You have to create the Private DNS Zone
manually using the following steps.

We will create a private domain name in an identical name to EDB Cloud PG
service's default domain name, i.e.
`p-c4ia6jleig40jngmac40.brcxzr08qr7rbei1.edbcloud.io`. This allows your
application to access the service in a consistent way from every place.
Azure's DNS resolving mechanism will ensure all access to this domain
name from `vnet-client` are resolved to private IP address of Private
Endpoint `pl-private-pg-service` instead of the original PG service's IP
address.

First, create a private DNS zone using the organization level domain
name as apex domain, `Brcxzr08qr7rbei1.edbcloud.io`.

IMAGE PLACEHOLDER

Then you need to link this private DNS Zone to VM virtual network
`vnet-client`, this is done through the **Virtual network** link on the
**Private DNS Zone** page of `brcxzr08qr7rbei1.edbcloud.io`.

IMAGE PLACEHOLDER

Then add a new record for the private endpoint, the address is a
private IP address associated with the private endpoint's NIC.

IMAGE PLACEHOLDER

Wait for a few second to let DNS setting fully propagate, then you can
start access your PG service with this private domain name.

IMAGE PLACEHOLDER

Sometimes, you may need to flush your local DNS cache, to resolve your
domain name to new private IP after adding the private endpoint. E.g. on
Ubuntu you can do this by:

```
  $ sudo systemd-resolve --flush-caches
```


### Azure Virtual Network Peering Example

Virtual network peering connects two Azure virtual networks. Once
peered, the virtual networks appear as one for connectivity purposes.
Traffic between virtual machines in the peered virtual networks is
routed through the Microsoft backbone infrastructure, through private IP
addresses and not the internet.

IMAGE PLACEHOLDER

!!! Note
    Two peered clusters can not have an overlapping IP range.
   Because you can't change the EDB Cloud cluster virtual network, if
   your application virtual network you plan to peer with happens to
   overlap with 10.240.0.0/16, you have to either update its IP space, or
   you have to use another connectivity solution.

#### Step 1: Create virtual network peering

You need to add two peerings links from both VM VNet "vnet-client" side
and your EDB Cloud VNet vnet-japaneast side, to simplify the process,
Azure will create both peering links for you when you add peering from
either side. For example, you can do it from VM VNet vnet-client side,
in the "Peerings" page of the Virtual Network portal.

We add two peering links called peer-client-edb and peer-edb-client,
they will join the address space of two virtual networks
together.

IMAGE PLACEHOLDER

IMAGE PLACEHOLDER

#### Step 2: Access EDB Cloud cluster PG service directly

Access EDB Cloud cluster PG with it's domain name from your cluster
connection string, it's accessible from "vnet-client" after peering.

IMAGE PLACEHOLDER


### Walkthrough: Connect Using Azure VNet-VNet Connection

The Azure resources you need to create in this approach include:

-   [Azure VPN Gateways](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways), one in each connected virtual network. See [Connect Using Azure VPN Gateway Point to Site](#connect-using-azure-vpn-gateway-point-to-site) for detailed resources created for a virtual network gateway.

#### Step 1: Create VPN Gateway for EDB Cloud cluster virtual network.

In the Azure portal "Virtual network gateway" page, create the first VPN
gateway for EDB Cloud Cluster resource virtual network vnet-japaneast.
The VPN gateway is called `vpng-edbcloud`.

It is worth noticing that a VPN gateway needs a dedicated subnet to
accommodate its gateway VMs, the subnet is called "GatewaySubnet", and
it is unique per virtual network. You can either create it by yourself
beforehand, or VPN gateway creation does this automatically, so you need
to ensure that your EDB Cloud virtual network address space has spare IP
range to use, otherwise. an "in use" error message will be shown aside
the virtual network you selected.

IMAGE PLACEHOLDER

#### Step 2: Create VPN Gateway for client VM virtual network

A VPN gateway creation can take upto 45 mins. You can create the second
gateway for your client VM virtual network vnet-client by repeating step
1, and create the client VPN gateway vpng-client.

#### Step 3: Add gateway connection between two VPN gateways

We need to add a VPN gateway connection from `vpng-edbcloud` side,
unfortunately Azure portal only supports creating gateway connection
between gateways from the same subscription, so in most cases you need
Azure CLI to do this. (For Windows user, PowerShell is another option,
see the detailed [PowerShell
guide](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps)
here)

-   [edbcloud subscription] Get VPN gateway id of `vpng-edbcloud`

  ```
  $ az network vnet-gateway show -n vpng-edbcloud -g
  brCxzr08qr7RBEi1-rg-japaneast-management --query "[id]" -otsv
  subscriptions\.../vpng-edbcloud
  ```

-   [vm subscription] Get VPN gateway id of `vpng-client`.

  ```
  $ az network vnet-gateway show -n vpng-client -g rg-client --query "[id]" -o tsv
  /subscriptions/.../vpng-client
  ```

-   [edbcloud subscription] Create a connection from `vpng-edbcloud` to `vpng-client` using the gateway ids you listed previously.

  ```
  $ az network vpn-connection create -n vpnc-edbcloud-client -g
  brCxzr08qr7RBEi1-rg-japaneast-management --vnet-gateway1
  /subscriptions/.../vpng-edbcloud -l japaneast --shared-key
  "a_very_long_and_complex_psk" \--vnet-gateway2
  /subscriptions/.../vpng-client
  ```

    "\--share-key" : this is a PSK you make for pairing authentication from both sides, it\'s an arbitrary key string, you will need it again
 from the other side.

-   [vm subscription] Create another connection from `vpng-client` to `vpng-ebdcloud`

    ```
    $ az network vpn-connection create -n vpnc-client-edbcloud -g
  rg-client --vnet-gateway1 /subscriptions/.../vpng-client -l japaneast
  --shared-key "a_very_long_and_complex_psk!" --vnet-gateway2
  /subscriptions/.../vpng-edbcloud
 ```

#### Step 4: Verify the connection

You can verify the Gateway connection's status with the following
command, from either side. The status may take minutes to get to
"Connected", from "Unknown" or "Connecting".

```
  $ az network vpn-connection show --name vpnc-client-edbcloud -g rg-client --query "[connectionStatus]" -o tsv
  Connected
```

  

Then let's verify the PG service connectivity. Behind the scene, cross
VNet routing rules through connected VPN gateways are added at both
virtual networks automatically, so all resources through all virtual
networks are mutually accessible directly.

IMAGE PLACEHOLDER


